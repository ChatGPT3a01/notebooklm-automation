{% extends "base.html" %}

{% block title %}åŸ·è¡Œä»‹é¢ - äº®è¨€~NotebookLM è‡ªå‹•åŒ–Skill{% endblock %}

{% block content %}
<div class="row g-2">
    <!-- å·¦å´ï¼šç­†è¨˜æœ¬é¸æ“‡ -->
    <div class="col-md-2 col-lg-2">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-journal-text me-2"></i>ç­†è¨˜æœ¬
                <button class="btn btn-sm btn-outline-primary float-end" onclick="loadNotebooks()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body">
                <select id="notebook-select" class="form-select mb-2" onchange="selectNotebook(this.value)">
                    <option value="">-- é¸æ“‡ç­†è¨˜æœ¬ --</option>
                </select>
                <button class="btn btn-sm btn-success w-100" onclick="showCreateNotebookModal()">
                    <i class="bi bi-plus-circle me-1"></i>å»ºç«‹æ–°ç­†è¨˜æœ¬
                </button>
            </div>
        </div>

        <!-- å¿«æ·åŠŸèƒ½ -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning me-2"></i>å¿«æ·åŠŸèƒ½
            </div>
            <div class="card-body p-2">
                <!-- ç­†è¨˜æœ¬ç®¡ç† -->
                <div class="mb-2">
                    <small class="text-muted fw-bold">ç­†è¨˜æœ¬</small>
                    <div class="d-flex flex-wrap gap-1 mt-1">
                        <button class="btn btn-outline-primary btn-sm" onclick="quickAction('list_notebooks')" title="åˆ—å‡ºç­†è¨˜æœ¬">
                            <i class="bi bi-list-ul"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="showCreateNotebookModal()" title="å»ºç«‹ç­†è¨˜æœ¬">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- ä¾†æºç®¡ç† -->
                <div class="mb-2">
                    <small class="text-muted fw-bold">ä¾†æº</small>
                    <div class="d-flex flex-wrap gap-1 mt-1">
                        <button class="btn btn-outline-info btn-sm" onclick="quickAction('list_sources')" title="åˆ—å‡ºä¾†æº">
                            <i class="bi bi-list-ul"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="showAddSourceModal()" title="æ–°å¢ä¾†æº">
                            <i class="bi bi-plus"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="showResearchModal()" title="ç¶²é ç ”ç©¶">
                            <i class="bi bi-globe"></i>
                        </button>
                    </div>
                </div>

                <!-- å…§å®¹ç”Ÿæˆ -->
                <div class="mb-2">
                    <small class="text-muted fw-bold">ç”Ÿæˆ</small>
                    <div class="d-flex flex-wrap gap-1 mt-1">
                        <button class="btn btn-outline-danger btn-sm" onclick="quickAction('generate_audio')" title="Podcast">
                            <i class="bi bi-mic-fill"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="quickAction('generate_video')" title="å½±ç‰‡">
                            <i class="bi bi-camera-video-fill"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="quickAction('generate_slides')" title="ç°¡å ±">
                            <i class="bi bi-easel-fill"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="quickAction('generate_quiz')" title="æ¸¬é©—">
                            <i class="bi bi-question-circle-fill"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="quickAction('generate_flashcards')" title="é–ƒå¡">
                            <i class="bi bi-card-text"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="quickAction('generate_report')" title="å ±å‘Š">
                            <i class="bi bi-file-text-fill"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="quickAction('generate_mindmap')" title="å¿ƒæ™ºåœ–">
                            <i class="bi bi-diagram-3-fill"></i>
                        </button>
                        <button class="btn btn-outline-purple btn-sm" onclick="quickAction('generate_infographic')" title="è³‡è¨Šåœ–è¡¨">
                            <i class="bi bi-bar-chart-fill"></i>
                        </button>
                        <button class="btn btn-outline-dark btn-sm" onclick="quickAction('generate_datatable')" title="æ•¸æ“šè¡¨">
                            <i class="bi bi-table"></i>
                        </button>
                    </div>
                </div>

                <!-- å…¶ä»– -->
                <div class="mb-0">
                    <small class="text-muted fw-bold">å…¶ä»–</small>
                    <div class="d-flex flex-wrap gap-1 mt-1">
                        <button class="btn btn-outline-secondary btn-sm" onclick="quickAction('list_artifacts')" title="ç”Ÿæˆå…§å®¹">
                            <i class="bi bi-collection"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="quickAction('check_status')" title="ç‹€æ…‹">
                            <i class="bi bi-info-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸­é–“ï¼šä¸»è¦åŸ·è¡Œå€åŸŸ -->
    <div class="col-md-8 col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-chat-dots me-2"></i>è‡ªç„¶èªè¨€åŸ·è¡Œ
            </div>
            <div class="card-body">
                <!-- è¼¸å…¥å€åŸŸ -->
                <div class="mb-3">
                    <textarea id="command-input" class="form-control" rows="3"
                        placeholder="è¼¸å…¥æ‚¨çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼š&#10;- å»ºç«‹ä¸€å€‹å«åšã€ŒAIç ”ç©¶ã€çš„ç­†è¨˜æœ¬&#10;- å¹«æˆ‘ç”Ÿæˆ Podcast&#10;- å•ä¸€ä¸‹é€™å€‹ç­†è¨˜æœ¬é—œæ–¼æ©Ÿå™¨å­¸ç¿’çš„å…§å®¹"></textarea>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary flex-grow-1" onclick="executeCommand()">
                        <i class="bi bi-play-fill me-1"></i>åŸ·è¡Œ
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearOutput()">
                        <i class="bi bi-trash me-1"></i>æ¸…é™¤
                    </button>
                </div>

                <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
                <hr>
                <div id="output-area">
                    <div class="text-muted text-center py-4">
                        <i class="bi bi-arrow-up-circle fs-1"></i>
                        <p class="mt-2">è¼¸å…¥æŒ‡ä»¤å¾ŒæŒ‰ã€ŒåŸ·è¡Œã€æŸ¥çœ‹çµæœ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å³å´ï¼šä»»å‹™ç‹€æ…‹ -->
    <div class="col-md-2 col-lg-2">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history me-2"></i>ä»»å‹™ç‹€æ…‹
                <button class="btn btn-sm btn-outline-primary float-end" onclick="loadTasks()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="tasks-list">
                    <div class="text-muted text-center py-3">
                        <i class="bi bi-inbox fs-4"></i>
                        <p class="small mt-1">æš«ç„¡é€²è¡Œä¸­çš„ä»»å‹™</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å»ºç«‹ç­†è¨˜æœ¬ Modal -->
<div class="modal fade" id="createNotebookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-journal-plus me-2"></i>å»ºç«‹æ–°ç­†è¨˜æœ¬</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="notebook-name" class="form-label">ç­†è¨˜æœ¬åç¨±</label>
                    <input type="text" class="form-control" id="notebook-name" placeholder="è¼¸å…¥ç­†è¨˜æœ¬åç¨±">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="createNotebook()">å»ºç«‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢ä¾†æº Modal -->
<div class="modal fade" id="addSourceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>æ–°å¢ä¾†æº</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ä¾†æºé¡å‹</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="sourceType" id="sourceTypeUrl" value="url" checked>
                        <label class="btn btn-outline-primary" for="sourceTypeUrl"><i class="bi bi-link-45deg"></i> ç¶²å€</label>

                        <input type="radio" class="btn-check" name="sourceType" id="sourceTypeYoutube" value="youtube">
                        <label class="btn btn-outline-danger" for="sourceTypeYoutube"><i class="bi bi-youtube"></i> YouTube</label>

                        <input type="radio" class="btn-check" name="sourceType" id="sourceTypeFile" value="file">
                        <label class="btn btn-outline-secondary" for="sourceTypeFile"><i class="bi bi-file-earmark"></i> æª”æ¡ˆè·¯å¾‘</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="source-value" class="form-label">ä¾†æºå…§å®¹</label>
                    <input type="text" class="form-control" id="source-value" placeholder="è¼¸å…¥ç¶²å€æˆ–æª”æ¡ˆè·¯å¾‘">
                    <div class="form-text">æ”¯æ´ï¼šURLã€YouTube ç¶²å€ã€PDF/TXT/MD/DOCX æª”æ¡ˆè·¯å¾‘</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="addSource()">æ–°å¢</button>
            </div>
        </div>
    </div>
</div>

<!-- ç¶²é ç ”ç©¶ Modal -->
<div class="modal fade" id="researchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-search me-2"></i>ç¶²é ç ”ç©¶</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="research-query" class="form-label">æœå°‹é—œéµå­—</label>
                    <input type="text" class="form-control" id="research-query" placeholder="è¼¸å…¥è¦ç ”ç©¶çš„ä¸»é¡Œ">
                </div>
                <div class="mb-3">
                    <label class="form-label">ç ”ç©¶æ¨¡å¼</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="researchMode" id="researchModeFast" value="fast" checked>
                        <label class="btn btn-outline-primary" for="researchModeFast"><i class="bi bi-lightning"></i> å¿«é€Ÿ (5-10 ä¾†æº)</label>

                        <input type="radio" class="btn-check" name="researchMode" id="researchModeDeep" value="deep">
                        <label class="btn btn-outline-warning" for="researchModeDeep"><i class="bi bi-layers"></i> æ·±åº¦ (20+ ä¾†æº)</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="startResearch()">é–‹å§‹ç ”ç©¶</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    loadNotebooks();
    loadTasks();
    // å®šæœŸæ›´æ–°ä»»å‹™ç‹€æ…‹
    setInterval(loadTasks, 5000);
});

// è¼‰å…¥ç­†è¨˜æœ¬åˆ—è¡¨
async function loadNotebooks() {
    try {
        const response = await fetch('/api/notebooks');
        const data = await response.json();

        const select = document.getElementById('notebook-select');
        select.innerHTML = '<option value="">-- é¸æ“‡ç­†è¨˜æœ¬ --</option>';

        if (data.success && data.data && data.data.notebooks) {
            data.data.notebooks.forEach(nb => {
                const option = document.createElement('option');
                option.value = nb.id;
                option.textContent = nb.title;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('è¼‰å…¥ç­†è¨˜æœ¬å¤±æ•—:', error);
    }
}

// é¸æ“‡ç­†è¨˜æœ¬
function selectNotebook(notebookId) {
    window.currentNotebookId = notebookId;
    if (notebookId) {
        showOutput(`å·²é¸æ“‡ç­†è¨˜æœ¬: ${notebookId}`, 'info');
    }
}

// åŸ·è¡ŒæŒ‡ä»¤
async function executeCommand() {
    const command = document.getElementById('command-input').value.trim();
    if (!command) {
        showOutput('è«‹è¼¸å…¥æŒ‡ä»¤', 'warning');
        return;
    }

    showOutput('åŸ·è¡Œä¸­...', 'info', true);

    try {
        const response = await fetch('/api/execute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                command: command,
                notebook_id: window.currentNotebookId
            })
        });

        const data = await response.json();
        displayResult(data);

        // å¦‚æœæœ‰ä»»å‹™ IDï¼Œé–‹å§‹è¿½è¹¤
        if (data.task_id) {
            trackTask(data.task_id);
        }
    } catch (error) {
        showOutput(`éŒ¯èª¤: ${error.message}`, 'danger');
    }
}

// å¿«æ·åŠŸèƒ½
function quickAction(action) {
    const commands = {
        // ç­†è¨˜æœ¬ç®¡ç†
        'list_notebooks': 'åˆ—å‡ºæˆ‘æ‰€æœ‰çš„ç­†è¨˜æœ¬',
        'check_status': 'æŸ¥çœ‹ç›®å‰ç‹€æ…‹',

        // ä¾†æºç®¡ç†
        'list_sources': 'åˆ—å‡ºé€™å€‹ç­†è¨˜æœ¬çš„ä¾†æº',

        // å…§å®¹ç”Ÿæˆ
        'generate_audio': 'å¹«æˆ‘ç”Ÿæˆ Podcast',
        'generate_video': 'å¹«æˆ‘ç”Ÿæˆå½±ç‰‡',
        'generate_slides': 'å¹«æˆ‘ç”Ÿæˆç°¡å ±',
        'generate_quiz': 'å¹«æˆ‘ç”Ÿæˆæ¸¬é©—',
        'generate_flashcards': 'å¹«æˆ‘ç”Ÿæˆé–ƒå¡',
        'generate_report': 'å¹«æˆ‘ç”Ÿæˆå ±å‘Š',
        'generate_mindmap': 'å¹«æˆ‘ç”Ÿæˆå¿ƒæ™ºåœ–',
        'generate_infographic': 'å¹«æˆ‘ç”Ÿæˆè³‡è¨Šåœ–è¡¨',
        'generate_datatable': 'å¹«æˆ‘ç”Ÿæˆæ•¸æ“šè¡¨',

        // å·¥ä»¶ç®¡ç†
        'list_artifacts': 'åˆ—å‡ºé€™å€‹ç­†è¨˜æœ¬çš„ç”Ÿæˆå…§å®¹'
    };

    document.getElementById('command-input').value = commands[action] || action;
    executeCommand();
}

// é¡¯ç¤ºçµæœ
function displayResult(data) {
    let html = '';

    if (data.success) {
        // æˆåŠŸè¨Šæ¯
        html = `<div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>
            ${data.message || 'åŸ·è¡ŒæˆåŠŸ'}
        </div>`;

        // æ ¹æ“šè³‡æ–™é¡å‹æ ¼å¼åŒ–é¡¯ç¤º
        if (data.data) {
            html += formatDataDisplay(data.data);
        }

        // ä»»å‹™ ID æç¤º
        if (data.task_id) {
            html += `<div class="alert alert-info mt-2">
                <i class="bi bi-hourglass-split me-2"></i>
                ä»»å‹™å·²å»ºç«‹ï¼ŒID: <code>${data.task_id}</code>
                <br><small class="text-muted">å¯åœ¨å³å´ã€Œä»»å‹™ç‹€æ…‹ã€æŸ¥çœ‹é€²åº¦</small>
            </div>`;
        }
    } else {
        // æª¢æŸ¥æ˜¯å¦ç‚ºã€Œæœªé¸æ“‡ç­†è¨˜æœ¬ã€éŒ¯èª¤
        const errorMsg = data.error || 'åŸ·è¡Œå¤±æ•—';
        const isNoNotebookError = errorMsg.includes('No notebook specified') ||
                                   errorMsg.includes('è«‹æŒ‡å®š') ||
                                   errorMsg.includes('æœªé¸æ“‡');

        if (isNoNotebookError) {
            html = `<div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>è«‹å…ˆé¸æ“‡ç­†è¨˜æœ¬</strong>
                <p class="mb-0 mt-2 small">è«‹åœ¨å·¦å´ä¸‹æ‹‰é¸å–®é¸æ“‡ä¸€å€‹ç­†è¨˜æœ¬ï¼Œæˆ–é»æ“Šã€Œåˆ—å‡ºç­†è¨˜æœ¬ã€å¾Œå¾åˆ—è¡¨ä¸­é¸æ“‡ã€‚</p>
            </div>`;
        } else {
            html = `<div class="alert alert-danger">
                <i class="bi bi-x-circle me-2"></i>
                ${errorMsg}
            </div>`;
        }
    }

    // è§£æè©³æƒ…ï¼ˆå¯å±•é–‹ï¼‰
    if (data.parsed) {
        html += `<details class="mt-2">
            <summary class="text-muted small"><i class="bi bi-code-slash me-1"></i>æŠ€è¡“è©³æƒ…</summary>
            <pre class="bg-light p-2 rounded small mt-1">${JSON.stringify(data.parsed, null, 2)}</pre>
        </details>`;
    }

    document.getElementById('output-area').innerHTML = html;
}

// æ ¼å¼åŒ–è³‡æ–™é¡¯ç¤º
function formatDataDisplay(data) {
    // ç­†è¨˜æœ¬åˆ—è¡¨
    if (data.notebooks && Array.isArray(data.notebooks)) {
        return formatNotebookList(data.notebooks, data.count);
    }

    // ä¾†æºåˆ—è¡¨
    if (data.sources && Array.isArray(data.sources)) {
        return formatSourceList(data.sources);
    }

    // å·¥ä»¶åˆ—è¡¨
    if (data.artifacts && Array.isArray(data.artifacts)) {
        return formatArtifactList(data.artifacts);
    }

    // å–®ä¸€ç­†è¨˜æœ¬
    if (data.id && data.title && !data.notebooks) {
        return formatSingleNotebook(data);
    }

    // å°è©±å›ç­”
    if (data.answer) {
        return formatChatAnswer(data);
    }

    // å¿ƒæ™ºåœ–
    if (data.mind_map) {
        return formatMindMap(data.mind_map);
    }

    // å…¶ä»–ï¼šé¡¯ç¤ºå‹å–„çš„ JSON
    return `<pre class="bg-light p-3 rounded small">${JSON.stringify(data, null, 2)}</pre>`;
}

// æ ¼å¼åŒ–ç­†è¨˜æœ¬åˆ—è¡¨
function formatNotebookList(notebooks, count) {
    let html = `<div class="mb-2"><strong>å…± ${count || notebooks.length} å€‹ç­†è¨˜æœ¬</strong></div>`;
    html += '<div class="table-responsive"><table class="table table-hover table-sm">';
    html += '<thead class="table-light"><tr><th>#</th><th>æ¨™é¡Œ</th><th>æ“æœ‰è€…</th><th>å»ºç«‹æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead><tbody>';

    notebooks.forEach((nb, index) => {
        const ownerBadge = nb.is_owner
            ? '<span class="badge bg-primary">æˆ‘çš„</span>'
            : '<span class="badge bg-secondary">å…±ç”¨</span>';
        const date = nb.created_at ? nb.created_at.split('T')[0] : '-';

        html += `<tr>
            <td>${index + 1}</td>
            <td><i class="bi bi-journal-text me-1 text-primary"></i>${escapeHtml(nb.title)}</td>
            <td>${ownerBadge}</td>
            <td><small class="text-muted">${date}</small></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="selectNotebookFromList('${nb.id}', '${escapeHtml(nb.title)}')">
                    <i class="bi bi-check2"></i> é¸æ“‡
                </button>
            </td>
        </tr>`;
    });

    html += '</tbody></table></div>';
    return html;
}

// æ ¼å¼åŒ–ä¾†æºåˆ—è¡¨
function formatSourceList(sources) {
    if (sources.length === 0) {
        return '<div class="text-muted text-center py-3"><i class="bi bi-inbox fs-3"></i><p>æ­¤ç­†è¨˜æœ¬å°šç„¡ä¾†æº</p></div>';
    }

    let html = `<div class="mb-2"><strong>å…± ${sources.length} å€‹ä¾†æº</strong></div>`;
    html += '<div class="list-group">';

    sources.forEach(src => {
        const statusBadge = src.status === 'ready'
            ? '<span class="badge bg-success">å°±ç·’</span>'
            : '<span class="badge bg-warning">è™•ç†ä¸­</span>';

        html += `<div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-file-earmark me-2 text-secondary"></i>
                <span>${escapeHtml(src.title || 'æœªå‘½å')}</span>
            </div>
            ${statusBadge}
        </div>`;
    });

    html += '</div>';
    return html;
}

// æ ¼å¼åŒ–å·¥ä»¶åˆ—è¡¨
function formatArtifactList(artifacts) {
    if (artifacts.length === 0) {
        return '<div class="text-muted text-center py-3"><i class="bi bi-inbox fs-3"></i><p>æ­¤ç­†è¨˜æœ¬å°šç„¡ç”Ÿæˆå…§å®¹</p></div>';
    }

    let html = `<div class="mb-2"><strong>å…± ${artifacts.length} å€‹ç”Ÿæˆå…§å®¹</strong></div>`;
    html += '<div class="list-group">';

    const typeIcons = {
        'Audio Overview': 'bi-mic-fill text-primary',
        'Video': 'bi-camera-video text-danger',
        'Quiz': 'bi-question-circle text-info',
        'Flashcards': 'bi-card-text text-warning',
        'Report': 'bi-file-text text-success',
        'Mind Map': 'bi-diagram-3 text-purple'
    };

    artifacts.forEach(artifact => {
        const icon = typeIcons[artifact.type] || 'bi-file-earmark';
        const statusClass = artifact.status === 'completed' ? 'bg-success' : 'bg-warning';

        html += `<div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <i class="bi ${icon} me-2"></i>
                <span>${escapeHtml(artifact.title || artifact.type)}</span>
            </div>
            <span class="badge ${statusClass}">${artifact.status}</span>
        </div>`;
    });

    html += '</div>';
    return html;
}

// æ ¼å¼åŒ–å–®ä¸€ç­†è¨˜æœ¬
function formatSingleNotebook(nb) {
    return `<div class="card">
        <div class="card-body">
            <h5 class="card-title"><i class="bi bi-journal-text me-2 text-primary"></i>${escapeHtml(nb.title)}</h5>
            <p class="card-text text-muted small">ID: <code>${nb.id}</code></p>
        </div>
    </div>`;
}

// æ ¼å¼åŒ–å°è©±å›ç­”
function formatChatAnswer(data) {
    let html = `<div class="card">
        <div class="card-body">
            <div class="mb-3">${formatMarkdown(data.answer)}</div>`;

    if (data.references && data.references.length > 0) {
        html += '<hr><div class="small text-muted"><strong>å¼•ç”¨ä¾†æºï¼š</strong><ul>';
        data.references.forEach(ref => {
            html += `<li>[${ref.citation_number}] ${escapeHtml(ref.cited_text || '').substring(0, 100)}...</li>`;
        });
        html += '</ul></div>';
    }

    html += '</div></div>';
    return html;
}

// æ ¼å¼åŒ–å¿ƒæ™ºåœ–
function formatMindMap(mindMap) {
    let html = `<div class="card">
        <div class="card-header bg-success text-white">
            <i class="bi bi-diagram-3 me-2"></i>å¿ƒæ™ºåœ–ï¼š${escapeHtml(mindMap.name || 'æœªå‘½å')}
        </div>
        <div class="card-body mindmap-container">
            <div class="mindmap-tree">`;

    // éè¿´ç”Ÿæˆæ¨¹ç‹€çµæ§‹
    html += renderMindMapNode(mindMap, 0);

    html += `</div>
        </div>
    </div>`;

    return html;
}

// éè¿´æ¸²æŸ“å¿ƒæ™ºåœ–ç¯€é»
function renderMindMapNode(node, level) {
    if (!node) return '';

    const colors = ['primary', 'success', 'info', 'warning', 'secondary', 'danger'];
    const color = colors[level % colors.length];
    const indent = level * 20;

    let html = `<div class="mindmap-node" style="margin-left: ${indent}px;">
        <span class="badge bg-${color} me-2">${level === 0 ? 'ğŸ¯' : 'â€¢'}</span>
        <span class="${level === 0 ? 'fw-bold fs-6' : (level === 1 ? 'fw-semibold' : '')}">${escapeHtml(node.name || '')}</span>
    </div>`;

    if (node.children && node.children.length > 0) {
        node.children.forEach(child => {
            html += renderMindMapNode(child, level + 1);
        });
    }

    return html;
}

// HTML è·³è„«
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ç°¡å–® Markdown è½‰æ›
function formatMarkdown(text) {
    if (!text) return '';
    return escapeHtml(text)
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');
}

// å¾åˆ—è¡¨é¸æ“‡ç­†è¨˜æœ¬
function selectNotebookFromList(id, title) {
    document.getElementById('notebook-select').value = id;
    window.currentNotebookId = id;
    showOutput(`å·²é¸æ“‡ç­†è¨˜æœ¬ï¼š${title}`, 'success');
}

// é¡¯ç¤ºè¼¸å‡º
function showOutput(message, type = 'info', loading = false) {
    const icons = {
        'success': 'check-circle',
        'danger': 'x-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };

    let html = `<div class="alert alert-${type}">
        <i class="bi bi-${icons[type]} me-2"></i>
        ${message}
        ${loading ? '<div class="spinner-border spinner-border-sm ms-2"></div>' : ''}
    </div>`;

    document.getElementById('output-area').innerHTML = html;
}

// æ¸…é™¤è¼¸å‡º
function clearOutput() {
    document.getElementById('output-area').innerHTML = `
        <div class="text-muted text-center py-4">
            <i class="bi bi-arrow-up-circle fs-1"></i>
            <p class="mt-2">è¼¸å…¥æŒ‡ä»¤å¾ŒæŒ‰ã€ŒåŸ·è¡Œã€æŸ¥çœ‹çµæœ</p>
        </div>`;
    document.getElementById('command-input').value = '';
}

// è¼‰å…¥ä»»å‹™åˆ—è¡¨
async function loadTasks() {
    try {
        const response = await fetch('/api/tasks');
        const data = await response.json();

        const tasksList = document.getElementById('tasks-list');

        if (data.success && data.tasks && data.tasks.length > 0) {
            let html = '';
            data.tasks.slice(-5).reverse().forEach(task => {
                const statusClass = {
                    'pending': 'warning',
                    'running': 'primary',
                    'completed': 'success',
                    'failed': 'danger'
                }[task.status] || 'secondary';

                const statusIcon = {
                    'pending': 'hourglass',
                    'running': 'arrow-repeat',
                    'completed': 'check-circle',
                    'failed': 'x-circle'
                }[task.status] || 'circle';

                html += `<div class="card mb-2">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-truncate" style="max-width: 150px;">${task.name}</small>
                            <span class="badge bg-${statusClass}">
                                <i class="bi bi-${statusIcon} me-1"></i>
                                ${task.status}
                            </span>
                        </div>
                        ${task.status === 'running' ? `<div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${task.progress}%"></div>
                        </div>` : ''}
                    </div>
                </div>`;
            });
            tasksList.innerHTML = html;
        } else {
            tasksList.innerHTML = `<div class="text-muted text-center py-3">
                <i class="bi bi-inbox fs-4"></i>
                <p class="small mt-1">æš«ç„¡é€²è¡Œä¸­çš„ä»»å‹™</p>
            </div>`;
        }
    } catch (error) {
        console.error('è¼‰å…¥ä»»å‹™å¤±æ•—:', error);
    }
}

// è¿½è¹¤ä»»å‹™
function trackTask(taskId) {
    loadTasks();
}

// é¡¯ç¤ºå»ºç«‹ç­†è¨˜æœ¬ Modal
function showCreateNotebookModal() {
    const modal = new bootstrap.Modal(document.getElementById('createNotebookModal'));
    modal.show();
}

// å»ºç«‹ç­†è¨˜æœ¬
async function createNotebook() {
    const name = document.getElementById('notebook-name').value.trim();
    if (!name) {
        alert('è«‹è¼¸å…¥ç­†è¨˜æœ¬åç¨±');
        return;
    }

    try {
        const response = await fetch('/api/notebooks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: name })
        });

        const data = await response.json();

        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createNotebookModal')).hide();
            document.getElementById('notebook-name').value = '';
            loadNotebooks();
            showOutput(`ç­†è¨˜æœ¬ã€Œ${name}ã€å»ºç«‹æˆåŠŸ`, 'success');
        } else {
            alert(data.error || 'å»ºç«‹å¤±æ•—');
        }
    } catch (error) {
        alert('å»ºç«‹å¤±æ•—: ' + error.message);
    }
}

// é¡¯ç¤ºæ–°å¢ä¾†æº Modal
function showAddSourceModal() {
    if (!window.currentNotebookId) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç­†è¨˜æœ¬');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('addSourceModal'));
    modal.show();
}

// æ–°å¢ä¾†æº
async function addSource() {
    const sourceType = document.querySelector('input[name="sourceType"]:checked').value;
    const sourceValue = document.getElementById('source-value').value.trim();

    if (!sourceValue) {
        alert('è«‹è¼¸å…¥ä¾†æºå…§å®¹');
        return;
    }

    if (!window.currentNotebookId) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç­†è¨˜æœ¬');
        return;
    }

    try {
        const response = await fetch(`/api/notebooks/${window.currentNotebookId}/sources`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: sourceType, value: sourceValue })
        });

        const data = await response.json();

        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addSourceModal')).hide();
            document.getElementById('source-value').value = '';
            showOutput(`ä¾†æºæ–°å¢æˆåŠŸ`, 'success');
        } else {
            alert(data.error || 'æ–°å¢å¤±æ•—');
        }
    } catch (error) {
        alert('æ–°å¢å¤±æ•—: ' + error.message);
    }
}

// é¡¯ç¤ºç¶²é ç ”ç©¶ Modal
function showResearchModal() {
    if (!window.currentNotebookId) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç­†è¨˜æœ¬');
        return;
    }
    const modal = new bootstrap.Modal(document.getElementById('researchModal'));
    modal.show();
}

// é–‹å§‹ç ”ç©¶
async function startResearch() {
    const query = document.getElementById('research-query').value.trim();
    const mode = document.querySelector('input[name="researchMode"]:checked').value;

    if (!query) {
        alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
        return;
    }

    if (!window.currentNotebookId) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç­†è¨˜æœ¬');
        return;
    }

    try {
        const response = await fetch(`/api/notebooks/${window.currentNotebookId}/research`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query, mode: mode })
        });

        const data = await response.json();

        bootstrap.Modal.getInstance(document.getElementById('researchModal')).hide();
        document.getElementById('research-query').value = '';

        if (data.success) {
            showOutput(`å·²é–‹å§‹ã€Œ${mode === 'fast' ? 'å¿«é€Ÿ' : 'æ·±åº¦'}ã€ç ”ç©¶ï¼š${query}`, 'success');
        } else {
            showOutput(data.error || 'ç ”ç©¶å•Ÿå‹•å¤±æ•—', 'danger');
        }
    } catch (error) {
        alert('ç ”ç©¶å•Ÿå‹•å¤±æ•—: ' + error.message);
    }
}
</script>
{% endblock %}
