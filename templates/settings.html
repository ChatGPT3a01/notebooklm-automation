{% extends "base.html" %}

{% block title %}設定 - 亮言~NotebookLM 自動化Skill{% endblock %}

{% block content %}
<h2 class="mb-4">
    <i class="bi bi-gear me-2"></i>設定
</h2>

<div class="row">
    <!-- 認證設定 -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-shield-check me-2"></i>認證設定
            </div>
            <div class="card-body">
                <div id="auth-section">
                    <div class="d-flex align-items-center mb-3">
                        <span class="me-2">登入狀態：</span>
                        <span id="auth-status-text" class="badge bg-secondary">檢查中...</span>
                    </div>
                    <div id="auth-details" class="mb-3 small text-muted"></div>
                    <button class="btn btn-primary" onclick="triggerLogin()">
                        <i class="bi bi-box-arrow-in-right me-1"></i>觸發登入
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="checkAuthStatus()">
                        <i class="bi bi-arrow-clockwise me-1"></i>重新檢查
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NLP 解析方式 -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-cpu me-2"></i>NLP 解析方式
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">選擇解析方式</label>
                    <select id="nlp-mode" class="form-select" onchange="updateNLPMode()">
                        <option value="keyword">關鍵字匹配（免費，速度快）</option>
                        <option value="gemini">Gemini API（更智慧，需 API Key）</option>
                        <option value="openai">OpenAI API（更智慧，需 API Key）</option>
                    </select>
                </div>

                <!-- Gemini 設定 -->
                <div id="gemini-settings" class="d-none">
                    <div class="mb-3">
                        <label class="form-label">Gemini API Key</label>
                        <input type="password" id="gemini-api-key" class="form-control" placeholder="輸入 API Key">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gemini 模型</label>
                        <select id="gemini-model" class="form-select">
                            <option value="gemini-2.5-flash">gemini-2.5-flash</option>
                            <option value="gemini-2.5-pro">gemini-2.5-pro</option>
                            <option value="gemini-3.0-flash">gemini-3.0-flash</option>
                            <option value="gemini-3.0-pro">gemini-3.0-pro</option>
                        </select>
                    </div>
                </div>

                <!-- OpenAI 設定 -->
                <div id="openai-settings" class="d-none">
                    <div class="mb-3">
                        <label class="form-label">OpenAI API Key</label>
                        <input type="password" id="openai-api-key" class="form-control" placeholder="輸入 API Key">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">OpenAI 模型</label>
                        <select id="openai-model" class="form-select">
                            <option value="gpt-4o">gpt-4o</option>
                            <option value="gpt-4.1">gpt-4.1</option>
                            <option value="gpt-4-turbo">gpt-4-turbo</option>
                            <option value="gpt-5.1">gpt-5.1</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 介面主題 -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-palette me-2"></i>介面主題
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="form-check card p-3 theme-option" data-theme="modern">
                            <input class="form-check-input" type="radio" name="theme" id="theme-modern" value="modern">
                            <label class="form-check-label w-100" for="theme-modern">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-circle-fill text-primary me-2"></i>
                                    <div>
                                        <strong>簡約現代</strong>
                                        <small class="d-block text-muted">簡潔卡片式設計</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-check card p-3 theme-option" data-theme="rich">
                            <input class="form-check-input" type="radio" name="theme" id="theme-rich" value="rich">
                            <label class="form-check-label w-100" for="theme-rich">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-stars text-warning me-2"></i>
                                    <div>
                                        <strong>豐富視覺</strong>
                                        <small class="d-block text-muted">更多圖示動畫</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-check card p-3 theme-option" data-theme="dark">
                            <input class="form-check-input" type="radio" name="theme" id="theme-dark" value="dark">
                            <label class="form-check-label w-100" for="theme-dark">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-moon-fill text-dark me-2"></i>
                                    <div>
                                        <strong>深色主題</strong>
                                        <small class="d-block text-muted">Dark mode</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-check card p-3 theme-option" data-theme="light">
                            <input class="form-check-input" type="radio" name="theme" id="theme-light" value="light">
                            <label class="form-check-label w-100" for="theme-light">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-sun-fill text-warning me-2"></i>
                                    <div>
                                        <strong>淺色主題</strong>
                                        <small class="d-block text-muted">Light mode</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 儲存按鈕 -->
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div id="save-status" class="text-muted"></div>
                    <button class="btn btn-primary btn-lg" onclick="saveSettings()">
                        <i class="bi bi-save me-2"></i>儲存設定
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 頁面載入時執行
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    checkAuthStatus();

    // 主題選擇事件
    document.querySelectorAll('input[name="theme"]').forEach(radio => {
        radio.addEventListener('change', function() {
            applyTheme(this.value);
        });
    });
});

// 載入設定
async function loadSettings() {
    try {
        const response = await fetch('/api/settings');
        const data = await response.json();

        if (data.success) {
            const config = data.config;

            // NLP 模式
            document.getElementById('nlp-mode').value = config.nlp_mode || 'keyword';
            updateNLPMode();

            // Gemini 設定
            if (config.gemini_model) {
                document.getElementById('gemini-model').value = config.gemini_model;
            }

            // OpenAI 設定
            if (config.openai_model) {
                document.getElementById('openai-model').value = config.openai_model;
            }

            // 主題
            const theme = config.theme || 'modern';
            document.getElementById('theme-' + theme).checked = true;
            applyTheme(theme);
        }
    } catch (error) {
        console.error('載入設定失敗:', error);
    }
}

// 更新 NLP 模式顯示
function updateNLPMode() {
    const mode = document.getElementById('nlp-mode').value;

    document.getElementById('gemini-settings').classList.add('d-none');
    document.getElementById('openai-settings').classList.add('d-none');

    if (mode === 'gemini') {
        document.getElementById('gemini-settings').classList.remove('d-none');
    } else if (mode === 'openai') {
        document.getElementById('openai-settings').classList.remove('d-none');
    }
}

// 儲存設定
async function saveSettings() {
    const settings = {
        nlp_mode: document.getElementById('nlp-mode').value,
        theme: document.querySelector('input[name="theme"]:checked')?.value || 'modern'
    };

    // Gemini 設定
    const geminiApiKey = document.getElementById('gemini-api-key').value;
    if (geminiApiKey && !geminiApiKey.startsWith('***')) {
        settings.gemini_api_key = geminiApiKey;
    }
    settings.gemini_model = document.getElementById('gemini-model').value;

    // OpenAI 設定
    const openaiApiKey = document.getElementById('openai-api-key').value;
    if (openaiApiKey && !openaiApiKey.startsWith('***')) {
        settings.openai_api_key = openaiApiKey;
    }
    settings.openai_model = document.getElementById('openai-model').value;

    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });

        const data = await response.json();

        if (data.success) {
            document.getElementById('save-status').innerHTML =
                '<span class="text-success"><i class="bi bi-check-circle me-1"></i>設定已儲存</span>';
            setTimeout(() => {
                document.getElementById('save-status').innerHTML = '';
            }, 3000);
        } else {
            alert('儲存失敗: ' + data.error);
        }
    } catch (error) {
        alert('儲存失敗: ' + error.message);
    }
}

// 檢查認證狀態
async function checkAuthStatus() {
    try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();

        const statusText = document.getElementById('auth-status-text');
        const detailsDiv = document.getElementById('auth-details');

        if (data.authenticated) {
            statusText.className = 'badge bg-success';
            statusText.innerHTML = '<i class="bi bi-check-circle me-1"></i>已登入';
            detailsDiv.innerHTML = '認證有效';
        } else {
            statusText.className = 'badge bg-danger';
            statusText.innerHTML = '<i class="bi bi-x-circle me-1"></i>未登入';
            detailsDiv.innerHTML = data.error || '請點擊「觸發登入」按鈕';
        }

        // 更新導航列的狀態指示器
        updateNavAuthStatus(data.authenticated);
    } catch (error) {
        console.error('檢查認證狀態失敗:', error);
    }
}

// 觸發登入
async function triggerLogin() {
    try {
        const response = await fetch('/api/auth/login', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
            alert('已開啟瀏覽器，請完成 Google 登入後，回到終端機按 Enter 確認。\n\n完成後請點擊「重新檢查」按鈕。');
        } else {
            alert('啟動登入失敗: ' + data.error);
        }
    } catch (error) {
        alert('啟動登入失敗: ' + error.message);
    }
}

// 套用主題
function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
}

// 更新導航列認證狀態
function updateNavAuthStatus(authenticated) {
    const badge = document.getElementById('auth-status');
    if (badge) {
        if (authenticated) {
            badge.className = 'badge bg-success';
            badge.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>已登入';
        } else {
            badge.className = 'badge bg-danger';
            badge.innerHTML = '<i class="bi bi-x-circle-fill me-1"></i>未登入';
        }
    }
}
</script>
{% endblock %}
